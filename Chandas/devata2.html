<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rigveda Devata Explorer</title>
    <style>
        :root {
            --primary: #b9562a;
            --bg: #fcfbf9;
            --card-bg: #ffffff;
            --text: #333;
            --border: #e0e0e0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }

        h1 { text-align: center; color: var(--primary); }
        
        .search-container {
            margin-bottom: 30px;
            position: sticky;
            top: 20px;
            z-index: 100;
        }

        input#searchBox {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            border: 2px solid var(--primary);
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            outline: none;
            box-sizing: border-box; /* Ensures padding doesn't break width */
        }

        .hint {
            text-align: center;
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        .card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }

        .card:hover { transform: translateY(-2px); }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }

        .devata-name { font-size: 1.4em; font-weight: bold; color: var(--primary); }
        .devata-sanskrit { font-size: 1.5em; color: #555; }
        .description { font-style: italic; color: #666; margin-bottom: 15px; }

        .tags { display: flex; flex-wrap: wrap; gap: 8px; }
        .tag {
            background-color: #f0f0f0;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: 500;
            cursor: pointer;
        }
        .tag:hover { background-color: var(--primary); color: white; }
        
        /* Error Box Styling */
        .error-box {
            background-color: #ffe6e6;
            border: 1px solid #ffcccc;
            color: #cc0000;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }
    </style>
</head>
<body>

    <h1>Rigveda Devata Mapper</h1>

    <div class="search-container">
        <input type="text" id="searchBox" placeholder="Loading data..." disabled>
        <div class="hint">Type a number (Mandala.Sukta) to find Devatas, or type text to find Suktas.</div>
    </div>

    <div id="resultsArea"></div>

<script>

// Global Indices
let devataIndex = []; 
let suktaIndex = {};  

// 1. Initialization Logic (Async to handle file loading)
async function init() {
    const resultsArea = document.getElementById('resultsArea');
    const searchBox = document.getElementById('searchBox');

    try {
        // Fetch the CSV file from the same directory
        // Note: This requires a local web server (e.g., Python SimpleHTTPServer or VS Code Live Server)
        const response = await fetch('devata.csv');

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const csvText = await response.text();
        
        parseCSV(csvText);
        
        // Enable search box
        searchBox.disabled = false;
        searchBox.placeholder = "Search by Name (e.g. Agni) or Sukta (e.g. 1.1)...";
        searchBox.addEventListener('input', handleSearch);
        
        renderResults(devataIndex); // Show all on load

    } catch (error) {
        console.error(error);
        resultsArea.innerHTML = `
            <div class="error-box">
                <h3>Could not load 'devata.csv'</h3>
                <p><strong>Error:</strong> ${error.message}</p>
                <p>If you opened this file by double-clicking it, your browser has blocked access to local files for security reasons (CORS).</p>
                <p><strong>Solution:</strong> You must serve this folder via a local web server (e.g., run <code>python -m http.server</code> in this folder).</p>
            </div>
        `;
    }
}

// 2. CSV Parser
function parseCSV(csvText) {
    // Normalize newlines to handle different OS formats
    const lines = csvText.replace(/\r\n/g, '\n').split('\n');
    
    // Reset indices
    devataIndex = [];
    suktaIndex = {};

    lines.forEach((line, index) => {
        if (!line.trim()) return; // Skip empty lines
        
        // CSV Splitter Logic
        // We assume standard CSV. If fields contain commas, this simple split will break.
        // If you have commas in descriptions, use a CSV library like PapaParse.
        const parts = line.split(',').map(s => s.trim());
        
        // Basic validation: need at least Name, Sanskrit, Desc, and 1 Ref
        if (parts.length < 4) return; 

        const devataObj = {
            name: parts[0],
            sanskrit: parts[1],
            desc: parts[2],
            // Filter out empty strings from the sukta list
            suktas: parts.slice(3).filter(s => s && s.length > 0) 
        };

        devataIndex.push(devataObj);

        // Build Inverted Index
        devataObj.suktas.forEach(sukta => {
            if (!suktaIndex[sukta]) {
                suktaIndex[sukta] = [];
            }
            suktaIndex[sukta].push({
                name: devataObj.name,
                sanskrit: devataObj.sanskrit,
                desc: devataObj.desc
            });
        });
    });
}

// 3. Search Logic (Unchanged)
function handleSearch(e) {
    const query = e.target.value.trim().toLowerCase();
    const resultsArea = document.getElementById('resultsArea');
    resultsArea.innerHTML = '';

    if (!query) {
        renderResults(devataIndex);
        return;
    }

    // REGEX: Detect if input is Mandala.Sukta pattern
    const isSuktaSearch = /^\d+(\.\d+)?$/.test(query);

    if (isSuktaSearch) {
        renderSuktaMode(query);
    } else {
        renderDevataMode(query);
    }
}

// 4. Rendering Logic (Unchanged)
function renderDevataMode(query) {
    const filtered = devataIndex.filter(d => 
        d.name.toLowerCase().includes(query) || 
        d.sanskrit.includes(query)
    );
    renderResults(filtered);
}

function renderSuktaMode(query) {
    const resultsArea = document.getElementById('resultsArea');
    const matchingSuktas = Object.keys(suktaIndex).filter(k => k.startsWith(query));
    
    if (matchingSuktas.length === 0) {
        resultsArea.innerHTML = '<p style="text-align:center">No records found for this Sukta.</p>';
        return;
    }

    matchingSuktas.sort((a, b) => a.localeCompare(b, undefined, { numeric: true }));

    let html = '';
    matchingSuktas.forEach(suktaNum => {
        const devataList = suktaIndex[suktaNum];
        let devataCards = devataList.map(d => `
            <div style="margin-left: 15px; padding: 5px 0; border-bottom: 1px dashed #eee;">
                <strong>${d.name} (${d.sanskrit})</strong> - ${d.desc}
            </div>
        `).join('');

        html += `
            <div class="card">
                <div class="card-header">
                    <span class="devata-name">Sukta ${suktaNum}</span>
                </div>
                <div>
                    <strong>Devatas referenced:</strong>
                    ${devataCards}
                </div>
            </div>
        `;
    });
    resultsArea.innerHTML = html;
}

function renderResults(data) {
    const resultsArea = document.getElementById('resultsArea');
    if (data.length === 0) {
        resultsArea.innerHTML = '<p style="text-align:center">No Devatas found.</p>';
        return;
    }

    const html = data.map(item => `
        <div class="card">
            <div class="card-header">
                <span class="devata-name">${item.name}</span>
                <span class="devata-sanskrit">${item.sanskrit}</span>
            </div>
            <div class="description">${item.desc}</div>
            <div>
                <strong>Referenced in Suktas:</strong>
                <div class="tags">
                    ${item.suktas.map(s => `<span class="tag" onclick="setSearch('${s}')">${s}</span>`).join('')}
                </div>
            </div>
        </div>
    `).join('');
    resultsArea.innerHTML = html;
}

window.setSearch = function(val) {
    const box = document.getElementById('searchBox');
    box.value = val;
    box.dispatchEvent(new Event('input'));
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// Run
init();

</script>
</body>
</html>